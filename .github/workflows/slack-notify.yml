name: Slack Notification
on:
  push:
    branches: ["**"] # ÂÖ®„Éñ„É©„É≥„ÉÅÂØæË±°
  pull_request:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Send Notification to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          AVATAR_URL: ${{ github.event.sender.avatar_url }}
        run: |
          # JSON„Ç®„Çπ„Ç±„Éº„ÉóÁî®„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
          escape_json() {
            if [ -z "$1" ]; then
              echo ""
            else
              echo "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g' | head -c 500
            fi
          }

          # --- 1. „Ç§„Éô„É≥„Éà„Åî„Å®„Å´„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ„Å®Ëâ≤„ÇíÂàá„ÇäÊõø„Åà„Çã ---
          if [ "$EVENT_NAME" == "push" ]; then
            EMOJI="üöÄ"
            TITLE="Push to \\\`${GITHUB_REF_NAME}\\\`"
            COMMIT_MSG=$(escape_json "${{ github.event.head_commit.message }}")
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:7}"
            URL="${{ github.event.head_commit.url }}"
            COLOR="good" # Green

            FIELDS_JSON=$(jq -nc \
              --arg url "$URL" \
              --arg sha "$SHORT_SHA" \
              --arg branch "$GITHUB_REF_NAME" \
              --arg actor "$ACTOR" \
              --arg repo "$REPO" \
              '[
                {"title":"Commit","value":"<\($url)|`\($sha)`>","short":true},
                {"title":"Branch","value":"`\($branch)`","short":true},
                {"title":"Author","value":"\($actor)","short":true},
                {"title":"Repository","value":"<https://github.com/\($repo)|\($repo)>","short":true}
              ]')
            MESSAGE="$COMMIT_MSG"

          elif [ "$EVENT_NAME" == "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE=$(escape_json "${{ github.event.pull_request.title }}")
            PR_BODY=$(escape_json "${{ github.event.pull_request.body }}")
            PR_USER="${{ github.event.pull_request.user.login }}"
            BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
            HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
            URL="${{ github.event.pull_request.html_url }}"
            ADDITIONS="${{ github.event.pull_request.additions }}"
            DELETIONS="${{ github.event.pull_request.deletions }}"
            CHANGED_FILES="${{ github.event.pull_request.changed_files }}"
            
            # „Éû„Éº„Ç∏„Åï„Çå„ÅüÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
              EMOJI="üéâ"
              TITLE="Pull Request Merged: #$PR_NUMBER"
              COLOR="#6f42c1" # Purple
            elif [ "$ACTION" == "opened" ]; then
              EMOJI="üì¨"
              TITLE="New Pull Request: #$PR_NUMBER"
              COLOR="warning" # Yellow
            elif [ "$ACTION" == "closed" ]; then
              EMOJI="üö´"
              TITLE="Pull Request Closed: #$PR_NUMBER"
              COLOR="#999999" # Gray
            elif [ "$ACTION" == "reopened" ]; then
              EMOJI="‚ôªÔ∏è"
              TITLE="Pull Request Reopened: #$PR_NUMBER"
              COLOR="warning" # Yellow
            else
              EMOJI="üîÑ"
              TITLE="Pull Request $ACTION: #$PR_NUMBER"
              COLOR="warning" # Yellow
            fi

            FIELDS_JSON=$(jq -nc \
              --arg user "$PR_USER" \
              --arg head "$HEAD_BRANCH" \
              --arg base "$BASE_BRANCH" \
              --arg adds "$ADDITIONS" \
              --arg dels "$DELETIONS" \
              --arg files "$CHANGED_FILES" \
              --arg action "$ACTION" \
              '[
                {"title":"Author","value":"\($user)","short":true},
                {"title":"Branch","value":"`\($head)` ‚Üí `\($base)`","short":true},
                {"title":"Changes","value":"+\($adds) / -\($dels) (\($files) files)","short":true},
                {"title":"Status","value":"\($action)","short":true}
              ]')
            MESSAGE="*$PR_TITLE*\\\\n${PR_BODY:0:200}"

          elif [ "$EVENT_NAME" == "issue_comment" ]; then
            EMOJI="üí¨"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE=$(escape_json "${{ github.event.issue.title }}")
            COMMENT_BODY=$(escape_json "${{ github.event.comment.body }}")
            COMMENT_USER="${{ github.event.comment.user.login }}"
            URL="${{ github.event.comment.html_url }}"
            COLOR="#007bff" # Blue
            
            # Issue„ÅãPR„Åã„ÇíÂà§ÂÆö
            if [ -n "${{ github.event.issue.pull_request.url }}" ]; then
              TITLE="Comment on PR #$ISSUE_NUMBER"
            else
              TITLE="Comment on Issue #$ISSUE_NUMBER"
            fi

            FIELDS_JSON=$(jq -nc \
              --arg user "$COMMENT_USER" \
              --arg num "$ISSUE_NUMBER" \
              --arg title "$ISSUE_TITLE" \
              '[
                {"title":"Commented by","value":"\($user)","short":true},
                {"title":"On","value":"#\($num): \($title)","short":true}
              ]')
            MESSAGE="$COMMENT_BODY"

          else
            EMOJI="‚ÑπÔ∏è"
            TITLE="Event Triggered: $EVENT_NAME"
            MESSAGE="Check GitHub for details."
            URL="https://github.com/$REPO"
            COLOR="#999999"
            FIELDS_JSON=""
          fi

          # --- 2. Slack„Å∏„ÅÆÈÄÅ‰ø°„Éá„Éº„Çø‰ΩúÊàê ---
          if [ -n "$FIELDS_JSON" ]; then
            PAYLOAD=$(jq -nc \
              --arg username "GitHub Notifications" \
              --arg icon ":github:" \
              --arg text "$EMOJI Notification from $REPO" \
              --arg color "$COLOR" \
              --arg author "$ACTOR" \
              --arg avatar "$AVATAR_URL" \
              --arg title "$TITLE" \
              --arg url "$URL" \
              --arg message "$MESSAGE" \
              --arg footer "<https://github.com/$REPO|$REPO>" \
              --arg footer_icon "https://github.githubassets.com/favicon.ico" \
              --argjson ts "$(date +%s)" \
              --argjson fields "$FIELDS_JSON" \
              '{
                username:$username,
                icon_emoji:$icon,
                text:$text,
                attachments:[{
                  color:$color,
                  author_name:$author,
                  author_icon:$avatar,
                  title:$title,
                  title_link:$url,
                  text:$message,
                  fields:$fields,
                  footer:$footer,
                  footer_icon:$footer_icon,
                  ts:$ts
                }]
              }')
          else
            PAYLOAD=$(jq -nc \
              --arg username "GitHub Notifications" \
              --arg icon ":github:" \
              --arg text "$EMOJI Notification from $REPO" \
              --arg color "$COLOR" \
              --arg author "$ACTOR" \
              --arg avatar "$AVATAR_URL" \
              --arg title "$TITLE" \
              --arg url "$URL" \
              --arg message "$MESSAGE" \
              --arg footer "<https://github.com/$REPO|$REPO>" \
              --arg footer_icon "https://github.githubassets.com/favicon.ico" \
              --argjson ts "$(date +%s)" \
              '{
                username:$username,
                icon_emoji:$icon,
                text:$text,
                attachments:[{
                  color:$color,
                  author_name:$author,
                  author_icon:$avatar,
                  title:$title,
                  title_link:$url,
                  text:$message,
                  footer:$footer,
                  footer_icon:$footer_icon,
                  ts:$ts
                }]
              }')
          fi

          # --- 3. Webhook URL „ÅÆÊ§úË®º ---
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "::warning::SLACK_WEBHOOK_URL is not set. Skipping notification."
            exit 0
          fi

          # --- 4. „Éá„Éê„ÉÉ„Ç∞Âá∫ÂäõÔºàURL„ÅØÈùûË°®Á§∫Ôºâ ---
          echo "Sending notification to Slack..."
          echo "Event: $EVENT_NAME"
          echo "Actor: $ACTOR"
          echo "Full Payload:"
          echo "$PAYLOAD"
          echo "---"

          # JSONÊ§úË®º
          if ! echo "$PAYLOAD" | jq . > /dev/null 2>&1; then
            echo "::warning::Payload is not valid JSON, attempting to send anyway..."
          else
            echo "‚úÖ Payload is valid JSON"
          fi

          # --- 5. ÈÄÅ‰ø°ÂÆüË°åÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ ---
          HTTP_CODE=$(echo "$PAYLOAD" | curl -X POST -H 'Content-type: application/json' \
            -d @- "$SLACK_WEBHOOK_URL" \
            -w '%{http_code}' \
            -s -o /tmp/slack_response.txt)

          # --- 6. „É¨„Çπ„Éù„É≥„Çπ„ÅÆÁ¢∫Ë™ç ---
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Successfully sent notification to Slack (HTTP $HTTP_CODE)"
          else
            echo "::error::Failed to send Slack notification. HTTP Code: $HTTP_CODE"
            echo "Response:"
            cat /tmp/slack_response.txt
            exit 1
          fi
